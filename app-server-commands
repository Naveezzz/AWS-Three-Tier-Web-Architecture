#!/bin/bash
# =========================================
# COMMANDS TO RUN IN THE APPLICATION SERVER (BACKEND EC2 INSTANCE)
# =========================================
# This script sets up the Node.js backend API

# =========================================
# INSTALLING MYSQL CLIENT
# =========================================
sudo -su ec2-user

sudo wget https://dev.mysql.com/get/mysql80-community-release-el9-1.noarch.rpm
sudo dnf install mysql80-community-release-el9-1.noarch.rpm -y
sudo rpm --import https://repo.mysql.com/RPM-GPG-KEY-mysql-2023
sudo dnf install mysql-community-client -y
mysql --version

# =========================================
# TEST DATABASE CONNECTION & SETUP
# =========================================
# IMPORTANT: Replace with your RDS endpoint, username, and password
# mysql -h my-rds-demo.c3sc2y2iq0tr.ap-south-1.rds.amazonaws.com -u admin -p

# After connecting, run these SQL commands:
# CREATE DATABASE webappdb;
# SHOW DATABASES;
# USE webappdb;
# CREATE TABLE IF NOT EXISTS users (
#   id INT NOT NULL AUTO_INCREMENT,
#   name VARCHAR(100) NOT NULL,
#   email VARCHAR(100) NOT NULL UNIQUE,
#   password VARCHAR(255) NOT NULL,
#   created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
#   PRIMARY KEY(id)
# );
# SHOW TABLES;
# DESCRIBE users;
# exit;

# =========================================
# COPY APP-TIER CODE FROM S3
# =========================================
cd /home/ec2-user

# IMPORTANT: Replace YOUR-BUCKET-NAME with your actual S3 bucket name
sudo aws s3 cp s3://demo-mybucket-nav2/application-code/app-tier app-tier --recursive

cd app-tier
sudo chown -R ec2-user:ec2-user /home/ec2-user/app-tier
sudo chmod -R 755 /home/ec2-user/app-tier

# =========================================
# UPDATE DATABASE CONFIGURATION
# =========================================
# IMPORTANT: Edit DbConfig.js with your RDS details
nano DbConfig.js
# Update: host, user, password

# =========================================
# INSTALLING NODEJS
# =========================================
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash
source ~/.bashrc

# Install Node.js version 16
nvm install 16
nvm use 16

# Verify installation
node --version
npm --version

# =========================================
# INSTALL DEPENDENCIES
# =========================================
npm install -g pm2
npm install

# Optional: Fix vulnerabilities
# npm audit fix

# =========================================
# START THE APPLICATION WITH PM2
# =========================================
pm2 start index.js

# View logs
pm2 logs

# List processes
pm2 list


# =========================================
# CONFIGURE PM2 TO START ON BOOT
# =========================================
pm2 startup
# Run the command shown by pm2 startup
sudo env PATH=$PATH:/home/ec2-user/.nvm/versions/node/v16.20.2/bin /home/ec2-user/.nvm/versions/node/v16.20.2/lib/node_modules/pm2/bin/pm2 startup systemd -u ec2-user --hp /home/ec2-user

pm2 save

# =========================================
# VERIFY APPLICATION
# =========================================
curl http://localhost:4000/health

# Test signup endpoint
curl -X POST http://localhost:4000/signup \
  -H "Content-Type: application/json" \
  -d '{"name":"Test User","email":"test@example.com","password":"password123"}'

# Test login endpoint
curl -X POST http://localhost:4000/login \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"password123"}'

echo "âœ… App tier setup complete!"